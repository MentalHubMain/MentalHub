-- Rayfield Admin Panel - FINAL V4 (Cleaned & Filtered)
-- REMOVED: Auto Crafting (Completely gone).
-- KEPT: Auto Collect Gear (Fixed version).
-- OPTIMIZED: Auto Hatch Listener now FILTERS OUT Fish/Weather events.
--            It only listens to 'state'/'sync'/'replecs' to target Eggs/Inventory.

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

getgenv().RayfieldNotifications = false

local Window = Rayfield:CreateWindow({
   Name = "Mental Hub",
   LoadingTitle = "Fishies OP Script",
   LoadingSubtitle = "Clean V4: Hatch & Collect",
   ConfigurationSaving = { Enabled = true, FolderName = "GardenAdmin", FileName = "Config" },
   KeySystem = false
})

local RemoteContainer = game:GetService("ReplicatedStorage")
   :WaitForChild("rbxts_include")
   :WaitForChild("node_modules")
   :WaitForChild("@rbxts")
   :WaitForChild("remo")
   :WaitForChild("src")
   :WaitForChild("container")

-- GLOBAL CLEANUP
getgenv().GardenAdminLoops = getgenv().GardenAdminLoops or {}
getgenv().GardenConnections = getgenv().GardenConnections or {}

-- Kill old loops
for _, loopThread in ipairs(getgenv().GardenAdminLoops) do
   if loopThread then task.cancel(loopThread) end
end
getgenv().GardenAdminLoops = {}

-- Disconnect old listeners
for _, conn in ipairs(getgenv().GardenConnections) do
    if conn then conn:Disconnect() end
end
getgenv().GardenConnections = {}

-- DATA & HELPERS
local UUID_Queue = {} 
local Processed_IDs = {} -- Cache to prevent duplicates

local function isUUID(str)
    return type(str) == "string" and str:match("%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x")
end

local function recursiveFindUUID(data)
    if type(data) == "table" then
        for k, v in pairs(data) do
            if isUUID(k) and not Processed_IDs[k] then 
                table.insert(UUID_Queue, k)
                Processed_IDs[k] = true
            end
            if isUUID(v) and not Processed_IDs[v] then 
                table.insert(UUID_Queue, v)
                Processed_IDs[v] = true
            end
            if type(v) == "table" then recursiveFindUUID(v) end
        end
    elseif isUUID(data) and not Processed_IDs[data] then
        table.insert(UUID_Queue, data)
        Processed_IDs[data] = true
    end
end

-- Setup Network Listener (FILTERED)
local function setupListener()
    for _, remote in pairs(RemoteContainer:GetDescendants()) do
        if remote:IsA("RemoteEvent") then
            local name = remote.Name:lower()
            
            -- WHITELIST: Only listen to Inventory/State updates
            if name:find("state") or name:find("replecs") or name:find("sync") or name:find("update") then
                
                -- BLACKLIST: Explicitly ignore Fish/Weather/Mutation events
                if not name:find("fish") and not name:find("weather") and not name:find("mutation") then
                    local conn = remote.OnClientEvent:Connect(function(...)
                        local args = {...}
                        recursiveFindUUID(args)
                    end)
                    table.insert(getgenv().GardenConnections, conn)
                end
            end
        end
    end
end
setupListener() -- Start Listener

local function safeBuy(remoteName, itemName)
    pcall(function() RemoteContainer[remoteName]:FireServer(itemName) end)
end

local loops = {autoCollectGear = false, egg = false, gear = false, bait = false, hatchListener = false}
local function startLoop(callback)
   local thread = task.spawn(callback)
   table.insert(getgenv().GardenAdminLoops, thread)
   return thread
end

-- TABS
local MainTab = Window:CreateTab("Main")
local MiscTab = Window:CreateTab("Misc")

-- [MAIN TAB]
MainTab:CreateSection("Egg Shop")
local selectedEggs = {}
MainTab:CreateDropdown({
   Name = "Eggs (Multi-Select)",
   Options = {"Starter", "Novice", "Forest", "Polar", "Tropical", "Exotic"},
   CurrentOption = {},
   MultipleOptions = true,
   Flag = "EggsDrop",
   Callback = function(v) selectedEggs = v end,
})
MainTab:CreateToggle({
   Name = "Auto Buy Eggs",
   CurrentValue = false,
   Callback = function(v)
      loops.egg = v
      if v then
         startLoop(function()
            while loops.egg do
               if #selectedEggs > 0 then
                   for _, egg in ipairs(selectedEggs) do
                      if not loops.egg then break end
                      safeBuy("shop.purchaseEgg", egg)
                   end
               end
               task.wait(0.15)
            end
         end)
      end
   end,
})

-- AUTO HATCH LISTENER SECTION
MainTab:CreateSection("Auto Hatch (Smart Listener)")
MainTab:CreateParagraph({Title = "Status", Content = "Filtering active: Ignores Fish/Weather IDs."})

MainTab:CreateToggle({
   Name = "Auto Hatch (Listen for IDs)",
   CurrentValue = false,
   Callback = function(v)
      loops.hatchListener = v
      if v then
         startLoop(function()
            while loops.hatchListener do
               -- Process the Queue
               if #UUID_Queue > 0 then
                   local idToTry = table.remove(UUID_Queue, 1) -- Get oldest ID
                   
                   -- Try to hatch (Invoke + Fire just in case)
                   task.spawn(function()
                       pcall(function() RemoteContainer["pets.hatchEgg"]:InvokeServer(idToTry) end)
                   end)
                   task.spawn(function()
                        pcall(function() RemoteContainer["pets.hatchEgg"]:FireServer(idToTry) end)
                   end)
                   
                   task.wait(0.05)
               else
                   task.wait(0.5)
               end
            end
         end)
      end
   end,
})

MainTab:CreateSection("Gear Shop")
local selectedGears = {}
MainTab:CreateDropdown({
   Name = "Gears (Multi-Select)",
   Options = {
      "BasicAutoFeeder", "FoodScoop", "BasicFoodTray", "NetMover",
      "MagnifyingGlass", "AdvancedAutoFeeder", "XpCookie", "TeleportWand",
      "StarLock", "SupremeAutoFeeder", "PetToy", "EggHatcher",
      "GoldenCookie", "EggIncubator"
   },
   CurrentOption = {},
   MultipleOptions = true,
   Flag = "GearsDrop",
   Callback = function(v) selectedGears = v end,
})
MainTab:CreateToggle({
   Name = "Auto Buy Gears",
   CurrentValue = false,
   Callback = function(v)
      loops.gear = v
      if v then
         startLoop(function()
            while loops.gear do
               if #selectedGears > 0 then
                   for _, gear in ipairs(selectedGears) do
                      if not loops.gear then break end
                      safeBuy("shop.purchaseGear", gear)
                   end
               end
               task.wait(0.05)
            end
         end)
      end
   end,
})

MainTab:CreateSection("Bait Shop")
local selectedBaits = {}
MainTab:CreateDropdown({
   Name = "Baits (Multi-Select)",
   Options = {
      "Starter", "Novice", "Reef", "DeepSea", "Koi", "River",
      "Puffer", "Glo", "Seal", "Ray", "Octopus", "Axolotl",
      "Jelly", "Whale", "Squid", "Shark", "Megalodon"
   },
   CurrentOption = {},
   MultipleOptions = true,
   Flag = "BaitsDrop",
   Callback = function(v) selectedBaits = v end,
})
MainTab:CreateToggle({
   Name = "Auto Buy Baits",
   CurrentValue = false,
   Callback = function(v)
      loops.bait = v
      if v then
         startLoop(function()
            while loops.bait do
               if #selectedBaits > 0 then
                   for _, bait in ipairs(selectedBaits) do
                      if not loops.bait then break end
                      safeBuy("shop.purchaseBait", bait)
                   end
               end
               task.wait(0.05)
            end
         end)
      end
   end,
})

MainTab:CreateSection("Auto Sell")
local sellDelay = 300
local loops_sell = false
MainTab:CreateToggle({
   Name = "Auto Sell All Fish",
   CurrentValue = false,
   Callback = function(v)
      loops_sell = v
      if v then
         startLoop(function()
            while loops_sell do
               pcall(function() RemoteContainer["sellFish.sellAllFish"]:FireServer() end)
               task.wait(sellDelay)
            end
         end)
      end
   end,
})
MainTab:CreateSlider({
   Name = "Sell Delay",
   Range = {30, 1800},
   Increment = 30,
   Suffix = "s",
   CurrentValue = 300,
   Callback = function(v) sellDelay = v end,
})

-- EVENT TAB
local EventTab = Window:CreateTab("Event")
EventTab:CreateSection("Event Shop")
local selectedEventItems = {}
EventTab:CreateDropdown({
   Name = "Event Items",
   Options = {
      "Atlantis Crate", "Trident Throne", "Poseidon Statue", "Kings Throne",
      "Atlantis Lightpole", "Atlantis Banner"
   },
   CurrentOption = {},
   MultipleOptions = true,
   Flag = "EventItemsDrop",
   Callback = function(v) selectedEventItems = v end,
})
EventTab:CreateToggle({
   Name = "Auto Buy Event Items",
   CurrentValue = false,
   Callback = function(v)
      local l_event = v
      if v then
         startLoop(function()
            while l_event do
               if #selectedEventItems > 0 then
                   for _, item in ipairs(selectedEventItems) do
                      if not l_event then break end
                      local remoteArg = item == "Atlantis Crate" and "baitpack:Atlantis" or item
                      safeBuy("shop.purchaseEventItem", remoteArg)
                   end
               end
               task.wait(0.05)
            end
         end)
      end
   end,
})

EventTab:CreateSection("Event Actions")
local eventSellDelay = 300
local loops_eventSell = false
EventTab:CreateToggle({
   Name = "Auto Sell Event Fish",
   CurrentValue = false,
   Callback = function(v)
      loops_eventSell = v
      if v then
         startLoop(function()
            while loops_eventSell do
               pcall(function() RemoteContainer["sellFish.sellAllEventFish"]:FireServer() end)
               task.wait(eventSellDelay)
            end
         end)
      end
   end,
})
EventTab:CreateSlider({
   Name = "Event Sell Delay",
   Range = {30, 1800},
   Increment = 30,
   Suffix = "s",
   CurrentValue = 300,
   Callback = function(v) eventSellDelay = v end,
})

local loops_sacrifice = false
EventTab:CreateToggle({
   Name = "Auto Sacrifice All Fish",
   CurrentValue = false,
   Callback = function(v)
      loops_sacrifice = v
      if v then
         startLoop(function()
            while loops_sacrifice do
               pcall(function() RemoteContainer["sellFish.sacrificeAllFish"]:FireServer() end)
               task.wait(1)
            end
         end)
      end
   end,
})

local loops_openCrate = false
EventTab:CreateToggle({
   Name = "Auto Open Crate (Fast)",
   CurrentValue = false,
   Callback = function(v)
      loops_openCrate = v
      if v then
         startLoop(function()
            while loops_openCrate do
               pcall(function()
                  RemoteContainer["tools.equipTool"]:FireServer("Atlantis:normal", "baitPack")
               end)
               task.wait(0.01)
               pcall(function()
                  RemoteContainer["store.openBaitPack"]:FireServer("Atlantis:normal")
               end)
               task.wait(0.01)
            end
         end)
      end
   end,
})

-- MISC TAB (Collect Only - Crafting Removed)
MiscTab:CreateSection("Gear Auto Collect")
local collectDelay = 2.5

MiscTab:CreateToggle({
    Name = "Auto Collect Gear",
    CurrentValue = false,
    Callback = function(v)
        loops.autoCollectGear = v
        if v then
            startLoop(function()
                while loops.autoCollectGear do
                    local success = pcall(function()
                        RemoteContainer["crafting.collectCraft"]:FireServer("gear")
                    end)
                    if success then
                        task.wait(collectDelay)
                    else
                        task.wait(5) -- Wait longer if nothing to collect
                    end
                end
            end)
        end
    end,
})

MiscTab:CreateSlider({
   Name = "Collect Delay",
   Range = {1, 10},
   Increment = 0.5,
   Suffix = "s",
   CurrentValue = 2.5,
   Callback = function(v) collectDelay = v end,
})

-- Misc: Merchant
MiscTab:CreateSection("Merchant")
local selectedMerchantItems = {}
MiscTab:CreateDropdown({
    Name = "Merchant Items",
    Options = {"Zoo", "Wild", "Punk", "Boba", "Ashen"},
    CurrentOption = {},
    MultipleOptions = true,
    Flag = "MerchantDrop",
    Callback = function(v) selectedMerchantItems = v end,
})
local loops_merchant = false
MiscTab:CreateToggle({
    Name = "Auto Buy Merchant",
    CurrentValue = false,
    Callback = function(v)
        loops_merchant = v
        if v then
            startLoop(function()
                while loops_merchant do
                   if #selectedMerchantItems > 0 then
                       for _, item in ipairs(selectedMerchantItems) do
                          if not loops_merchant then break end
                          pcall(function() RemoteContainer["merchant.purchaseItem"]:FireServer("travelling", item) end)
                       end
                   end
                   task.wait(0.5)
                end
            end)
        end
    end,
})

-- On Load
pcall(function() RemoteContainer["crafting.collectCraft"]:FireServer("gear") end)

Rayfield:LoadConfiguration()
